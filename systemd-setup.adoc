= Setting Up Daily 2am Build of antora-playbook-genealogy

== âœ… *PREREQUISITE 0 â€” Convert both repositories to HTTPS (required for systemd builds)*

Systemd user services cannot use SSH keys (no agent, no passphrase
prompt). Therefore, the Git remotes _must_ use HTTPS.

=== For `+antora-genealogy+`:

[source,bash]
----
cd /home/kurt/antora-genealogy
git remote set-url origin https://github.com/kurt-krueckeberg/antora-genealogy.git
git pull
----

=== For `+antora-immanuel+`:

[source,bash]
----
cd /home/kurt/antora-immanuel
git remote set-url origin https://github.com/kurt-krueckeberg/antora-immanuel.git
git pull
----

These must run *without* requiring a password or SSH key. Once they do,
systemd can run them automatically.

'''''

== âœ… *PREREQUISITE 1 â€” Enable user lingering*

This allows your userâ€™s systemd services and timers to run even when
youâ€™re not logged in.

Run as *root*:

[source,bash]
----
sudo loginctl enable-linger kurt
----

Verify:

[source,bash]
----
loginctl show-user kurt | grep Linger
----

Expect:

....
Linger=yes
....

'''''

== âœ… *PREREQUISITE 2 â€” Fix deploy directory permissions*

Run as *root*:

[source,bash]
----
sudo chown -R kurt:www-data /var/www/krueckeberg.org/docs
sudo chmod -R g+w /var/www/krueckeberg.org/docs
----

This ensures your `+vps-build+` script can deploy without sudo.

'''''

== ğŸ“‚ *STEP 1 â€” Create the systemd user directory*

Run as *kurt*:

[source,bash]
----
mkdir -p ~/.config/systemd/user
----

'''''

== ğŸ“„ *STEP 2 â€” Create `+antora-build.service+`*

[source,bash]
----
nano ~/.config/systemd/user/antora-build.service
----

Paste:

[source,ini]
----
[Unit]
Description=Antora Build and Deploy

[Service]
Type=oneshot
WorkingDirectory=/home/kurt/antora-playbook-genealogy

# Make sure npx/node are visible to systemd
Environment="PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/home/kurt/.local/bin"

ExecStart=/home/kurt/antora-playbook-genealogy/vps-build

# Log to a permanent file
StandardOutput=append:/home/kurt/antora-build.log
StandardError=append:/home/kurt/antora-build.log
----

Save â†’ exit.

'''''

== ğŸ•‘ *STEP 3 â€” Create `+antora-build.timer+`*

[source,bash]
----
nano ~/.config/systemd/user/antora-build.timer
----

Paste:

[source,ini]
----
[Unit]
Description=Run Antora build daily at 2AM

[Timer]
OnCalendar=*-*-* 02:00:00
Persistent=true

[Install]
WantedBy=timers.target
----

Save â†’ exit.

'''''

== ğŸ”„ *STEP 4 â€” Reload systemd to recognize new files*

[source,bash]
----
systemctl --user daemon-reload
----

'''''

== â–¶ï¸ *STEP 5 â€” Enable and start the timer*

[source,bash]
----
systemctl --user enable --now antora-build.timer
----

This:

* enables the timer on boot/login
* starts its schedule immediately

'''''

== â–¶ï¸ *STEP 6 â€” (Optional) Manual test*

[source,bash]
----
systemctl --user start antora-build.service
----

Check the build log:

[source,bash]
----
cat /home/kurt/antora-build.log
----

'''''

== ğŸ” *STEP 7 â€” Confirm the timer is scheduled*

[source,bash]
----
systemctl --user list-timers
----

You should see:

....
NEXT                         LEFT        LAST
Sat 2025-12-05 02:00:00 EST  12h         Thu ...
antora-build.timer â†’ antora-build.service
....

'''''

== ğŸ‰ *DONE â€” You now have a fully automated, systemd-driven Antora build pipeline.*

'''''

== ğŸ“Œ Full copy-and-paste installation summary

....
# 0. Convert repos to HTTPS
cd /home/kurt/antora-genealogy
git remote set-url origin https://github.com/kurt-krueckeberg/antora-genealogy.git
git pull

cd /home/kurt/antora-immanuel
git remote set-url origin https://github.com/kurt-krueckeberg/antora-immanuel.git
git pull

# 1. Enable user lingering
sudo loginctl enable-linger kurt

# 2. Permissions for deploy directory
sudo chown -R kurt:www-data /var/www/krueckeberg.org/docs
sudo chmod -R g+w /var/www/krueckeberg.org/docs

# 3. Create systemd user directory
mkdir -p ~/.config/systemd/user

# 4. Create service file
nano ~/.config/systemd/user/antora-build.service

# 5. Create timer file
nano ~/.config/systemd/user/antora-build.timer

# 6. Reload systemd
systemctl --user daemon-reload

# 7. Enable and start the timer
systemctl --user enable --now antora-build.timer

# 8. Optional manual build test
systemctl --user start antora-build.service

# 9. Check timers
systemctl --user list-timers
....

